<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chief of Staff - Organizational Intelligence Platform</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #7c3aed;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            color: var(--dark);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            background: #1e3a8a;
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
            margin-bottom: 20px;
        }
        
        .header .description {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            line-height: 1.8;
            font-size: 1rem;
        }
        
        .header .description strong {
            color: #fbbf24;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #1e3a8a;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 14px 28px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            color: white;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: #1e3a8a;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid #1e40af;
            color: white;
        }
        
        .card h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #fbbf24;
            border-radius: 2px;
        }
        
        .card p {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Query Input */
        .query-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .query-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .query-input {
            flex: 1;
            padding: 18px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .query-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .query-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .voice-btn {
            padding: 18px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .voice-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .voice-btn.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Response */
        .response {
            margin-top: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border-left: 4px solid #fbbf24;
            min-height: 120px;
            line-height: 1.8;
        }
        
        .response-content {
            color: white;
        }
        
        .response-content h1, .response-content h2, .response-content h3 {
            color: #fbbf24;
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .response-content h1 {
            font-size: 1.75rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 12px;
        }
        
        .response-content h2 {
            font-size: 1.5rem;
        }
        
        .response-content h3 {
            font-size: 1.25rem;
        }
        
        .response-content strong, .response-content b {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .response-content em, .response-content i {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }
        
        .response-content ul, .response-content ol {
            margin: 16px 0;
            padding-left: 32px;
        }
        
        .response-content li {
            margin: 10px 0;
        }
        
        .response-content code {
            background: #e5e7eb;
            padding: 3px 8px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--danger);
        }
        
        .response-content blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 20px;
            margin: 20px 0;
            color: var(--gray);
            font-style: italic;
        }
        
        .response-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            color: var(--primary);
            padding: 30px;
            font-size: 16px;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error {
            color: var(--danger);
            background: #fef2f2;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--danger);
            margin-top: 20px;
        }
        
        /* Graph */
        #graphContainer {
            width: 100%;
            height: 700px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: #fafafa;
            margin-top: 20px;
        }
        
        .graph-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .graph-controls select {
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }
        
        .graph-info {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.8;
            color: white;
        }
        
        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .insight-item {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .insight-item:hover {
            transform: translateY(-4px);
        }
        
        .insight-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .insight-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Agent Outputs */
        .agent-output {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #fbbf24;
            color: white;
        }
        
        .agent-output h3 {
            color: #fbbf24;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .agent-output pre {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .query-input-wrapper {
                flex-direction: column;
            }
            
            #graphContainer {
                height: 500px;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ AI Chief of Staff</h1>
            <p class="subtitle">Organizational Intelligence & Communication Analysis Platform</p>
            <div class="description">
                <strong>What This Platform Does:</strong> The AI Chief of Staff is a superhuman organizational intelligence system that processes, analyzes, and understands your organization's communication patterns. It reads and processes emails, builds a comprehensive knowledge graph of relationships and topics, and provides intelligent insights through agentic reasoning. The system uses advanced AI agents (Memory, Critic, and Coordinator) to detect patterns, identify stakeholders, and generate actionable summaries. The interactive dashboard allows you to query organizational data, visualize communication networks, and understand how information flows through your organization.
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('query')">üí¨ Query AI</button>
            <button class="tab" onclick="switchTab('graph')">üï∏Ô∏è Communication Graph</button>
            <button class="tab" onclick="switchTab('insights')">üìä Insights</button>
            <button class="tab" onclick="switchTab('agents')">ü§ñ Agentic Reasoning</button>
        </div>
        
        <!-- Query Tab -->
        <div id="queryTab" class="tab-content active">
            <div class="card">
                <h2>Ask Your AI Chief of Staff</h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                    Ask questions about your organization's communications, relationships, and patterns. 
                    You can type your query or use voice input by clicking the microphone button.
                </p>
                <div class="query-container">
                    <div class="query-input-wrapper">
                        <input type="text" class="query-input" id="queryInput" 
                               placeholder="e.g., Who are the top communicators? What topics are discussed most? Analyze communication patterns..." />
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="Voice Input">
                            üé§
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="queryAI()">
                            <span>üîç</span> Query
                        </button>
                        <button class="btn btn-secondary" onclick="clearResponse()">
                            Clear
                        </button>
                    </div>
                </div>
                <div id="response" class="response" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Graph Tab -->
        <div id="graphTab" class="tab-content">
            <div class="card">
                <h2>Communication Network Visualization</h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                    Interactive network graph showing communication relationships. Nodes represent people, edges represent communications. 
                    Drag nodes to rearrange, scroll to zoom, and click nodes for details.
                </p>
                <div class="graph-controls">
                    <button class="btn" onclick="loadGraph()">üìä Load Graph</button>
                    <button class="btn btn-secondary" onclick="refreshGraph()">üîÑ Refresh</button>
                    <select id="graphLimit">
                        <option value="50">50 nodes</option>
                        <option value="100" selected>100 nodes</option>
                        <option value="200">200 nodes</option>
                        <option value="500">500 nodes</option>
                    </select>
                </div>
                <div id="graphContainer"></div>
                <div id="graphInfo" class="graph-info">
                    Click "Load Graph" to visualize the communication network from Neo4j.
                </div>
            </div>
        </div>
        
        <!-- Insights Tab -->
        <div id="insightsTab" class="tab-content">
            <div class="card">
                <h2>Organizational Insights</h2>
                <div id="insights" class="insights-grid">
                    <div class="loading">Loading insights</div>
                </div>
            </div>
        </div>
        
        <!-- Agents Tab -->
        <div id="agentsTab" class="tab-content">
            <div class="card">
                <h2>Agentic Reasoning Layer</h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                    Advanced AI agents analyze your organizational data to provide intelligent insights, detect patterns, and identify stakeholders.
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <button class="btn" onclick="runMemoryAgent()">üß† Memory Agent</button>
                    <button class="btn" onclick="runCriticAgent()">üîç Critic Agent</button>
                    <button class="btn" onclick="runCoordinatorAgent()">üë• Coordinator Agent</button>
                    <button class="btn" onclick="getWhatChanged()">üìÖ What Changed Today</button>
                </div>
                <div id="agentOutput" class="agent-output" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let network = null;
        let graphData = null;
        let recognition = null;
        let isRecording = false;
        
        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('queryInput').value = transcript;
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording');
                queryAI();
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording');
                alert('Speech recognition error. Please try again.');
            };
            
            recognition.onend = function() {
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording');
            };
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'insights') {
                loadInsights();
            } else if (tabName === 'agents') {
                // Load agent info
            }
        }
        
        // Voice input
        function toggleVoiceInput() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser. Please use Chrome or Edge.');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording');
            } else {
                recognition.start();
                isRecording = true;
                document.getElementById('voiceBtn').classList.add('recording');
            }
        }
        
        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadInsights();
        });
        
        // Enter key to submit
        document.getElementById('queryInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                queryAI();
            }
        });
        
        // Query AI
        async function queryAI() {
            const query = document.getElementById('queryInput').value.trim();
            const responseDiv = document.getElementById('response');
            const btn = document.querySelector('#queryTab .btn');
            
            if (!query) {
                responseDiv.innerHTML = '<div class="error">Please enter a query</div>';
                responseDiv.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading">Thinking</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, include_emails: true })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    responseDiv.innerHTML = `<div class="error">${data.error}</div>`;
                } else {
                    let formattedResponse = formatResponse(data.response);
                    responseDiv.innerHTML = `<div class="response-content">${formattedResponse}</div>`;
                    if (data.relevant_emails_count > 0) {
                        responseDiv.innerHTML += `<div class="response-footer"><em>Based on ${data.relevant_emails_count} relevant emails</em></div>`;
                    }
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        function clearResponse() {
            document.getElementById('response').style.display = 'none';
            document.getElementById('queryInput').value = '';
        }
        
        // Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format response
        function formatResponse(text) {
            if (!text) return '';
            
            // First escape HTML to prevent XSS
            let escaped = escapeHtml(text);
            
            // Then apply markdown formatting (on escaped content)
            let html = escaped
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            if (!html.startsWith('<h') && !html.startsWith('<p')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }
        
        // Load insights
        async function loadInsights() {
            const insightsDiv = document.getElementById('insights');
            
            try {
                const response = await fetch(`${API_BASE}/api/insights`);
                const data = await response.json();
                
                if (data.error) {
                    insightsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                insightsDiv.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-value">${data.total_emails || 0}</div>
                        <div class="insight-label">Total Emails</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-value">${data.unique_senders || 0}</div>
                        <div class="insight-label">Unique Senders</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-value">${data.unique_receivers || 0}</div>
                        <div class="insight-label">Unique Receivers</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-value">${data.communication_network_size || 0}</div>
                        <div class="insight-label">Network Nodes</div>
                    </div>
                `;
            } catch (error) {
                insightsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Load graph
        async function loadGraph() {
            const container = document.getElementById('graphContainer');
            const infoDiv = document.getElementById('graphInfo');
            const limit = document.getElementById('graphLimit').value;
            
            infoDiv.innerHTML = '<div class="loading">Loading graph data from Neo4j</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/graph?limit=${limit}`);
                const data = await response.json();
                
                if (data.error || !data.nodes || data.nodes.length === 0) {
                    infoDiv.innerHTML = `<div class="error">${data.error || 'No graph data found. Please run: python load_graph_data.py'}</div>`;
                    return;
                }
                
                graphData = data;
                
                const nodes = new vis.DataSet(
                    data.nodes.map(node => ({
                        id: node.id,
                        label: node.label || node.id.split('@')[0],
                        value: node.value || 1,
                        title: `${node.label || node.id}\nCommunications: ${node.value || 0}`,
                        color: { background: '#2563eb', border: '#1e40af' }
                    }))
                );
                
                const edges = new vis.DataSet(
                    data.edges.map(edge => ({
                        from: edge.from,
                        to: edge.to,
                        value: edge.value || 1,
                        title: `Communications: ${edge.value || 0}`,
                        color: { color: '#6b7280', highlight: '#2563eb' }
                    }))
                );
                
                const graphDataVis = { nodes: nodes, edges: edges };
                
                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 25,
                        font: { size: 16, face: 'Inter', color: '#ffffff' },
                        borderWidth: 3,
                        shadow: true,
                        color: { background: '#2563eb', border: '#1e40af', highlight: { background: '#10b981', border: '#059669' } }
                    },
                    edges: {
                        width: 2,
                        smooth: { type: 'continuous', roundness: 0.3 },
                        arrows: { to: { enabled: true, scaleFactor: 0.8 } },
                        color: { color: '#64748b', highlight: '#2563eb' },
                        length: 200
                    },
                    physics: {
                        enabled: true,
                        stabilization: { iterations: 300 },
                        barnesHut: {
                            gravitationalConstant: -3000,
                            centralGravity: 0.1,
                            springLength: 250,
                            springConstant: 0.04,
                            damping: 0.09,
                            avoidOverlap: 1
                        },
                        repulsion: {
                            centralGravity: 0.1,
                            springLength: 250,
                            springConstant: 0.04,
                            nodeDistance: 300,
                            damping: 0.09
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200,
                        zoomView: true,
                        dragView: true
                    },
                    layout: {
                        improvedLayout: true,
                        hierarchical: {
                            enabled: false
                        }
                    }
                };
                
                network = new vis.Network(container, graphDataVis, options);
                
                infoDiv.innerHTML = `
                    <strong>Graph Statistics:</strong><br>
                    Nodes (People): ${data.nodes.length}<br>
                    Edges (Communications): ${data.edges.length}<br>
                    <em>Drag nodes to rearrange, scroll to zoom, click nodes for details</em>
                `;
                
                network.on("click", function (params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const node = nodes.get(nodeId);
                        infoDiv.innerHTML = `
                            <strong>Selected Node:</strong><br>
                            ${node.label}<br>
                            Communications: ${node.value}<br>
                            <button class="btn" onclick="viewPersonNetwork('${nodeId}')" style="margin-top: 10px;">View Network</button>
                        `;
                    }
                });
                
            } catch (error) {
                infoDiv.innerHTML = `<div class="error">Error loading graph: ${error.message}</div>`;
            }
        }
        
        function refreshGraph() {
            loadGraph();
        }
        
        async function viewPersonNetwork(email) {
            const container = document.getElementById('graphContainer');
            const infoDiv = document.getElementById('graphInfo');
            
            infoDiv.innerHTML = '<div class="loading">Loading person network</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/graph/person/${encodeURIComponent(email)}?depth=2`);
                const data = await response.json();
                
                if (data.error) {
                    infoDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                const nodes = new vis.DataSet(data.nodes.map(node => ({
                    id: node.id,
                    label: node.label || node.id.split('@')[0],
                    title: node.label || node.id
                })));
                
                const edges = new vis.DataSet(data.edges.map(edge => ({
                    from: edge.from,
                    to: edge.to,
                    value: edge.value || 1
                })));
                
                network = new vis.Network(container, { nodes: nodes, edges: edges }, {
                    nodes: { shape: 'dot', size: 20, font: { size: 14 } },
                    edges: { width: 3, arrows: { to: { enabled: true } } }
                });
                
                infoDiv.innerHTML = `<strong>Person Network:</strong><br>Showing network for: ${email}<br>Nodes: ${data.nodes.length}, Edges: ${data.edges.length}`;
            } catch (error) {
                infoDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Agent functions with visual flow
        async function runMemoryAgent() {
            const outputDiv = document.getElementById('agentOutput');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="loading">üß† Memory Agent: Updating knowledge base</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/agents/memory`, { method: 'POST' });
                const data = await response.json();
                
                let html = `<h3>üß† Memory Agent - Knowledge Versioning</h3>`;
                html += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">`;
                html += `<strong>Status:</strong> ${data.summary || 'Knowledge updated'}<br>`;
                html += `<strong>Version:</strong> ${data.version || 'N/A'}<br>`;
                html += `<strong>Last Updated:</strong> ${data.updated || 'N/A'}<br>`;
                html += `</div>`;
                html += `<div style="margin-top: 15px;"><strong>Communication Flow:</strong></div>`;
                html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-family: monospace; font-size: 12px;">`;
                html += `Email Data ‚Üí Memory Agent ‚Üí Knowledge Graph ‚Üí Versioned Storage<br>`;
                html += `‚úì Analyzed communication patterns<br>`;
                html += `‚úì Updated stakeholder relationships<br>`;
                html += `‚úì Versioned organizational knowledge`;
                html += `</div>`;
                html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #fbbf24;">View Raw JSON</summary><pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre></details>`;
                
                outputDiv.innerHTML = html;
            } catch (error) {
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function runCriticAgent() {
            const outputDiv = document.getElementById('agentOutput');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="loading">üîç Critic Agent: Analyzing conflicts</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/agents/critic`, { method: 'POST' });
                const data = await response.json();
                
                let html = `<h3>üîç Critic Agent - Conflict Detection</h3>`;
                html += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">`;
                html += `<strong>Summary:</strong> ${data.summary || 'Analysis complete'}<br>`;
                html += `<strong>Conflicts Found:</strong> ${data.conflicts?.length || 0}<br>`;
                html += `<strong>Topic Clusters:</strong> ${data.duplications?.total_topics || 0}`;
                html += `</div>`;
                
                if (data.conflicts && data.conflicts.length > 0) {
                    html += `<div style="margin-top: 15px;"><strong>Detected Conflicts:</strong></div>`;
                    data.conflicts.slice(0, 5).forEach((conflict, idx) => {
                        html += `<div style="margin: 10px 0; padding: 12px; background: rgba(239,68,68,0.2); border-left: 3px solid #ef4444; border-radius: 6px;">`;
                        html += `<strong>${idx + 1}. ${conflict.type}:</strong> ${conflict.topic || conflict.person || 'N/A'}<br>`;
                        html += `Severity: ${conflict.severity || 'unknown'}`;
                        html += `</div>`;
                    });
                }
                
                html += `<div style="margin-top: 15px;"><strong>Communication Flow:</strong></div>`;
                html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-family: monospace; font-size: 12px;">`;
                html += `Email Data ‚Üí Critic Agent ‚Üí Pattern Analysis ‚Üí Conflict Detection<br>`;
                html += `‚úì Scanned ${data.conflicts?.length || 0} potential conflicts<br>`;
                html += `‚úì Identified ${data.duplications?.total_topics || 0} topic clusters<br>`;
                html += `‚úì Flagged duplicated communications`;
                html += `</div>`;
                html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #fbbf24;">View Raw JSON</summary><pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre></details>`;
                
                outputDiv.innerHTML = html;
            } catch (error) {
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function runCoordinatorAgent() {
            const outputDiv = document.getElementById('agentOutput');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="loading">üë• Coordinator Agent: Identifying stakeholders</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/agents/coordinator`, { method: 'POST' });
                const data = await response.json();
                
                let html = `<h3>üë• Coordinator Agent - Stakeholder Mapping</h3>`;
                html += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">`;
                
                if (data.topic) {
                    html += `<strong>Topic:</strong> ${data.topic}<br>`;
                    html += `<strong>Total Stakeholders:</strong> ${data.summary?.total_stakeholders || data.stakeholders?.length || 0}<br>`;
                    html += `<strong>High Relevance:</strong> ${data.summary?.high_count || 0}<br>`;
                    html += `<strong>Medium Relevance:</strong> ${data.summary?.medium_count || 0}<br>`;
                    html += `<strong>Low Relevance:</strong> ${data.summary?.low_count || 0}`;
                } else if (data.person) {
                    html += `<strong>Person:</strong> ${data.person}<br>`;
                    html += `<strong>Total Communications:</strong> ${data.total_communications || 0}<br>`;
                    html += `<strong>Key Stakeholders:</strong> ${data.stakeholders?.length || 0}`;
                } else {
                    html += `<strong>Total Stakeholders:</strong> ${data.total || data.stakeholders?.length || 0}`;
                }
                
                html += `</div>`;
                
                if (data.stakeholders && data.stakeholders.length > 0) {
                    html += `<div style="margin-top: 15px;"><strong>Top Stakeholders:</strong></div>`;
                    data.stakeholders.slice(0, 10).forEach((stakeholder, idx) => {
                        html += `<div style="margin: 8px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">`;
                        html += `${idx + 1}. ${stakeholder.email || stakeholder.person || 'N/A'}: `;
                        html += `${stakeholder.involvement || stakeholder.communications || 0} interactions`;
                        html += `</div>`;
                    });
                }
                
                html += `<div style="margin-top: 15px;"><strong>Communication Flow:</strong></div>`;
                html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-family: monospace; font-size: 12px;">`;
                html += `Email Data ‚Üí Coordinator Agent ‚Üí Network Analysis ‚Üí Stakeholder Mapping<br>`;
                html += `‚úì Analyzed communication networks<br>`;
                html += `‚úì Identified key stakeholders<br>`;
                html += `‚úì Mapped relationship relevance`;
                html += `</div>`;
                html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #fbbf24;">View Raw JSON</summary><pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre></details>`;
                
                outputDiv.innerHTML = html;
            } catch (error) {
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function getWhatChanged() {
            const outputDiv = document.getElementById('agentOutput');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="loading">üìÖ Generating What Changed Today</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/agents/what-changed`, { method: 'POST' });
                const data = await response.json();
                
                let html = `<h3>üìÖ What Changed Today - Daily Summary</h3>`;
                
                if (data.message) {
                    html += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">${data.message}</div>`;
                } else {
                    html += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">`;
                    html += `<strong>Version:</strong> ${data.version || 'N/A'}<br>`;
                    html += `<strong>Timestamp:</strong> ${data.timestamp || 'N/A'}<br>`;
                    html += `<strong>Changes Detected:</strong> ${data.changes?.length || 0}`;
                    html += `</div>`;
                    
                    if (data.changes && data.changes.length > 0) {
                        html += `<div style="margin-top: 15px;"><strong>Key Changes:</strong></div>`;
                        data.changes.forEach((change, idx) => {
                            const delta = change.delta || 0;
                            const color = delta > 0 ? '#10b981' : delta < 0 ? '#ef4444' : '#fbbf24';
                            html += `<div style="margin: 10px 0; padding: 12px; background: rgba(255,255,255,0.05); border-left: 3px solid ${color}; border-radius: 6px;">`;
                            html += `<strong>${change.type}:</strong> ${change.person || change.topic || 'N/A'}<br>`;
                            html += `Previous: ${change.previous || 0} ‚Üí Current: ${change.current || 0} `;
                            if (delta !== 0) {
                                html += `(${delta > 0 ? '+' : ''}${delta})`;
                            }
                            html += `</div>`;
                        });
                    }
                }
                
                html += `<div style="margin-top: 15px;"><strong>Communication Flow:</strong></div>`;
                html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-family: monospace; font-size: 12px;">`;
                html += `Memory Agent ‚Üí Version Comparison ‚Üí Change Detection ‚Üí Summary Generation<br>`;
                html += `‚úì Compared current vs previous knowledge state<br>`;
                html += `‚úì Identified ${data.changes?.length || 0} significant changes<br>`;
                html += `‚úì Generated daily organizational summary`;
                html += `</div>`;
                html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #fbbf24;">View Raw JSON</summary><pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre></details>`;
                
                outputDiv.innerHTML = html;
            } catch (error) {
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
